generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model business_profiles {
  id           String                       @id
  userId       String
  personType   business_profiles_personType @default(PJ)
  status       business_profiles_status     @default(UNVERIFIED)
  cpf          String?                      @unique
  companyName  String?
  cnpj         String?                      @unique
  tradingName  String?
  description  String?                      @db.Text
  companyLogo  String?
  categories   String?
  cep          String?
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  latitude     Float?
  longitude    Float?
  instagram    String?
  facebook     String?
  whatsapp     String?
  website      String?
  createdAt    DateTime                     @default(now())
  updatedAt    DateTime
  users        users                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Multi-tenant relationships
  categoriesRelation      categories[]
  contactsRelation        contacts[]
  leadCapturesRelation    lead_captures[]
  messagingInstances      messaging_instances[]
  messagingGroups         messaging_groups[]
  productsRelation        products[]
  quotesRelation          quotes[]
  stockEntriesRelation    stock_entries[]

  @@index([userId])
}

model categories {
  id                String             @id
  userId            String
  businessProfileId String?
  name              String
  description       String?            @db.Text
  icon              String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  users             users              @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile   business_profiles? @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  products          products[]

  @@unique([userId, name])
  @@index([userId])
  @@index([businessProfileId])
}

enum ChannelType {
  whatsapp_evolution
  whatsapp_oficial
  sms
  email
  telegram
  facebook
}

model integration_credentials {
  id                  String                @id
  name                String                @unique
  type                ChannelType
  credentials         String                @db.LongText
  isActive            Boolean               @default(true)
  description         String?               @db.Text
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  messaging_instances messaging_instances[]

  @@index([isActive])
  @@index([type])
}

model messaging_instances {
  id                 String                   @id
  userId             String
  businessProfileId  String?
  name               String?
  channel            ChannelType
  channelInstanceId  String
  channelPhoneOrId   String
  status             String                   @default("pending")
  metadata           String?                  @db.LongText
  credentialId       String?
  lastConnectedAt    DateTime?
  lastDisconnectedAt DateTime?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime
  users              users                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile    business_profiles?       @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  messaging_messages messaging_messages[]
  messaging_groups   messaging_groups[]
  credential         integration_credentials? @relation(fields: [credentialId], references: [id], onDelete: SetNull)

  @@unique([channel, channelInstanceId])
  @@index([channel])
  @@index([status])
  @@index([userId])
  @@index([credentialId])
  @@index([businessProfileId])
}

model messaging_messages {
  id                  String              @id
  userId              String
  instanceId          String
  channel             String
  remoteJid           String
  message             String              @db.Text
  channelMessageId    String?             @unique
  direction           String              @default("sent")
  status              String              @default("pending")
  mediaUrl            String?
  mediaType           String?
  error               String?
  retries             Int                 @default(0)
  maxRetries          Int                 @default(3)
  sentAt              DateTime?
  deliveredAt         DateTime?
  readAt              DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  messaging_instances messaging_instances @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  users               users               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([channel])
  @@index([instanceId])
  @@index([status])
  @@index([userId])
}

enum messaging_groups_type {
  CUSTOM
  SYNCED_WHATSAPP
  SYNCED_TELEGRAM
  SYNCED_EMAIL
}

model messaging_groups {
  id                String                 @id
  userId            String
  businessProfileId String?
  instanceId        String
  name              String
  description       String?                @db.Text
  type              messaging_groups_type  @default(CUSTOM)
  externalGroupId   String?
  metadata          String?                @db.LongText
  isSynced          Boolean                @default(false)
  lastSyncAt        DateTime?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime
  users             users                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile   business_profiles?     @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  messagingInstance messaging_instances    @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  members           messaging_group_members[]

  @@unique([instanceId, externalGroupId])
  @@index([userId])
  @@index([businessProfileId])
  @@index([instanceId])
  @@index([isSynced])
}

model messaging_group_members {
  id             String           @id
  groupId        String
  identifier     String
  identifierType String
  name           String?
  metadata       String?          @db.Text
  isActive       Boolean          @default(true)
  addedAt        DateTime         @default(now())
  group          messaging_groups @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, identifier])
  @@index([groupId])
  @@index([identifier])
}

model products {
  id                String             @id
  userId            String
  businessProfileId String?
  categoryId        String
  name              String
  description       String?            @db.Text
  sku               String
  price             Float
  quantity          Int                // Mantido para compatibilidade (usado para PHYSICAL)
  image             String?            // Mantido para compatibilidade
  
  // Novo: Tipo de produto
  type              ProductType        @default(PHYSICAL)
  
  // Novo: Imagens múltiplas (JSON)
  images            Json?
  
  // Novo: Metadados extras flexíveis
  metadata          Json?
  
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  
  // Relacionamentos existentes
  categories        categories         @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  users             users              @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile   business_profiles? @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  quote_items       quote_items[]
  stock_entries     stock_entries[]
  
  // Novos relacionamentos com tabelas específicas por tipo
  physicalData      ProductPhysical?
  serviceData       ProductService?
  courseData        ProductCourse?
  digitalData       ProductDigital?
  subscriptionData  ProductSubscription?
  eventData         ProductEvent?

  @@unique([userId, sku])
  @@index([categoryId])
  @@index([userId])
  @@index([businessProfileId])
  @@index([type])
}

enum ProductType {
  PHYSICAL
  SERVICE
  COURSE
  DIGITAL
  SUBSCRIPTION
  EVENT
}

model ProductPhysical {
  id        String   @id @default(uuid())
  productId String   @unique
  product   products @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  stock     Int      @default(0)
  sku       String?
  weight    Float?
  width     Float?
  height    Float?
  depth     Float?
  variations Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductService {
  id            String   @id @default(uuid())
  productId     String   @unique
  product       products @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  duration      Int?
  scheduling    Boolean  @default(false)
  location      String?
  professionals Json?
  extras        Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ProductCourse {
  id            String   @id @default(uuid())
  productId     String   @unique
  product       products @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  platform      String?
  modules       Int?
  lessons       Int?
  durationHours Int?
  certificate   Boolean  @default(false)
  accessDays    Int?
  level         String?
  content       Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ProductDigital {
  id             String   @id @default(uuid())
  productId      String   @unique
  product        products @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  fileUrl        String?
  fileSize       Int?
  fileType       String?
  downloadLimit  Int?
  licenseType    String?
  expirationDays Int?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ProductSubscription {
  id           String   @id @default(uuid())
  productId    String   @unique
  product      products @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  billingCycle String?
  trialDays    Int?
  maxUsers     Int?     @default(1)
  benefits     Json?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ProductEvent {
  id          String    @id @default(uuid())
  productId   String    @unique
  product     products  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  eventDate   DateTime?
  location    String?
  capacity    Int?
  ticketsSold Int       @default(0)
  category    String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model quote_items {
  id        String   @id
  quoteId   String
  productId String
  quantity  Int
  unitPrice Float
  total     Float
  createdAt DateTime @default(now())
  updatedAt DateTime
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  quotes    quotes   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([quoteId])
}

model quotes {
  id                String             @id
  userId            String
  businessProfileId String?
  status            String             @default("pending")
  discount          Float              @default(0)
  tax               Float              @default(0)
  total             Float
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  quoteNumber       String?
  quote_items       quote_items[]
  users             users              @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile   business_profiles? @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
  @@index([businessProfileId])
}

model scheduled_messages {
  id           String    @id
  userId       String
  instanceName String
  phoneNumber  String
  message      String    @db.Text
  scheduledFor DateTime
  status       String    @default("pending")
  sentAt       DateTime?
  error        String?
  messageId    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  users        users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([scheduledFor])
  @@index([status])
  @@index([userId])
}

model scheduled_tasks {
  id           String    @id
  userId       String
  actionType   String
  payload      String    @db.LongText
  scheduledFor DateTime
  status       String    @default("pending")
  result       String?   @db.LongText
  error        String?
  attempts     Int       @default(0)
  maxRetries   Int       @default(3)
  executedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  users        users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([actionType])
  @@index([scheduledFor])
  @@index([status])
  @@index([userId])
}

model sessions {
  id           String   @id
  userId       String
  accessToken  String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_userId_fkey")
}

model stock_entries {
  id                String             @id
  userId            String
  businessProfileId String?
  productId         String
  quantity          Int
  type              String             @default("in")
  reason            String?
  reference         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  products          products           @relation(fields: [productId], references: [id], onDelete: Cascade)
  users             users              @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile   business_profiles? @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([businessProfileId])
}

model users {
  id                    String                  @id
  email                 String                  @unique
  name                  String
  password              String?
  avatar                String?
  phone                 String?
  cpf                   String?                 @unique
  birthDate             DateTime?
  whatsapp              String?
  instagram             String?
  facebook              String?
  role                  users_role              @default(USER)
  provider              users_provider?         @default(LOCAL)
  providerId            String?
  status                String                  @default("ACTIVE")
  isVerified            Boolean                 @default(false)
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  business_profiles     business_profiles[]
  categories            categories[]
  messaging_instances   messaging_instances[]
  messaging_messages    messaging_messages[]
  messaging_groups      messaging_groups[]
  products              products[]
  quotes                quotes[]
  scheduled_messages    scheduled_messages[]
  scheduled_tasks       scheduled_tasks[]
  sessions              sessions[]
  stock_entries         stock_entries[]
  whatsapp_instances    whatsapp_instances[]
  whatsapp_message_logs whatsapp_message_logs[]
  contacts              contacts[]
  lead_captures         lead_captures[]
  contact_activities    contact_activities[]
}

model whatsapp_instances {
  id                    String                  @id
  userId                String
  instanceName          String                  @unique
  phoneNumber           String?
  status                String                  @default("close")
  state                 String                  @default("DISCONNECTED")
  qrCode                String?                 @db.LongText
  webhookUrl            String?
  lastConnectedAt       DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  users                 users                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  whatsapp_message_logs whatsapp_message_logs[]

  @@index([instanceName])
  @@index([userId])
}

model whatsapp_message_logs {
  id                 String             @id
  userId             String
  instanceId         String
  remoteJid          String
  message            String             @db.Text
  messageId          String             @unique
  direction          String             @default("sent")
  status             String             @default("pending")
  mediaUrl           String?
  error              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  whatsapp_instances whatsapp_instances @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  users              users              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([messageId])
  @@index([userId])
}

enum business_profiles_personType {
  PF
  PJ
}

enum business_profiles_status {
  UNVERIFIED
  VERIFIED
  CANCELLED
}

enum users_role {
  USER
  SELLER
  ADMIN
}

enum users_provider {
  LOCAL
  GOOGLE
  FACEBOOK
}

model contacts {
  id                String               @id @default(uuid())
  userId            String
  businessProfileId String?
  
  name            String
  email           String?
  phone           String?
  cpf             String?              @unique
  
  company         String?
  position        String?
  website         String?
  
  street          String?
  number          String?
  complement      String?
  neighborhood    String?
  city            String?
  state           String?
  zipCode         String?
  country         String?              @default("Brasil")
  
  birthDate       DateTime?
  notes           String?              @db.LongText
  tags            String?
  customFields    String?              @db.LongText
  
  source          String?
  sourceUrl       String?
  leadCaptureId   String?
  
  status          String               @default("active")
  isLead          Boolean              @default(false)
  leadScore       Int                  @default(0)
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  convertedAt     DateTime?
  
  user            users                @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile business_profiles?   @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  leadCapture     lead_captures?       @relation(fields: [leadCaptureId], references: [id])
  activities      contact_activities[]
  
  @@index([userId])
  @@index([businessProfileId])
  @@index([email])
  @@index([phone])
  @@index([isLead])
  @@index([status])
  @@index([leadCaptureId])
  @@index([createdAt])
}

model lead_captures {
  id                String             @id @default(uuid())
  userId            String
  businessProfileId String?
  
  name             String
  title            String
  description      String?    @db.Text
  
  fields           String     @db.LongText
  requiredFields   String     @db.LongText
  
  submitButtonText String     @default("Enviar")
  successMessage   String     @db.Text
  redirectUrl      String?
  
  webhookUrl       String?
  notifyEmail      String?
  
  isActive         Boolean    @default(true)
  slug             String     @unique
  totalCaptures    Int        @default(0)
  
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  
  user             users              @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessProfile  business_profiles? @relation(fields: [businessProfileId], references: [id], onDelete: Cascade)
  contacts         contacts[]
  
  @@index([userId])
  @@index([businessProfileId])
  @@index([slug])
  @@index([isActive])
}

model contact_activities {
  id          String    @id @default(uuid())
  contactId   String
  userId      String?
  
  type        String
  title       String
  description String?   @db.Text
  
  metadata    String?   @db.LongText
  
  createdAt   DateTime  @default(now())
  
  contact     contacts  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user        users?    @relation(fields: [userId], references: [id])
  
  @@index([contactId])
  @@index([type])
  @@index([createdAt])
}
