generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  SELLER
  ADMIN
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
}

enum PersonType {
  PF
  PJ
}

enum BusinessProfileStatus {
  UNVERIFIED
  VERIFIED
  CANCELLED
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String
  password     String?
  avatar       String?
  phone        String?
  cpf          String?       @unique
  birthDate    DateTime?
  whatsapp     String?
  instagram    String?
  facebook     String?
  role         UserRole      @default(USER)
  provider     AuthProvider? @default(LOCAL)
  providerId   String?
  status       String        @default("ACTIVE")
  isVerified   Boolean       @default(false)
  isActive     Boolean       @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessProfiles      BusinessProfile[]
  sessions              Session[]
  whatsappInstances     WhatsAppInstance[]
  whatsappMessageLogs   WhatsAppMessageLog[]

  scheduledMessages  ScheduledMessage[]
  scheduledTasks      ScheduledTask[]
  @@map("users")
}

model BusinessProfile {
  id     String @id @default(cuid())
  userId String

  personType PersonType @default(PJ)
  status     BusinessProfileStatus @default(UNVERIFIED)

  cpf String? @unique
  companyName String?
  cnpj        String? @unique
  tradingName String?
  description String? @db.Text
  companyLogo String?
  categories  String?

  cep          String?
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  latitude     Float?
  longitude    Float?

  instagram String?
  facebook  String?
  whatsapp  String?
  website   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("business_profiles")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  accessToken  String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model WhatsAppInstance {
  id           String   @id @default(cuid())
  userId       String
  instanceName String   @unique
  phoneNumber  String?
  status       String   @default("close")
  state        String   @default("DISCONNECTED")
  qrCode       String?  @db.LongText
  webhookUrl   String?

  lastConnectedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  messageLogs  WhatsAppMessageLog[]

  @@index([userId])
  @@index([instanceName])
  @@map("whatsapp_instances")
}

model WhatsAppMessageLog {
  id           String   @id @default(cuid())
  userId       String
  instanceId   String
  remoteJid    String
  message      String   @db.Text
  messageId    String   @unique
  direction    String   @default("sent")
  status       String   @default("pending")
  mediaUrl     String?
  error        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  instance WhatsAppInstance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([instanceId])
  @@index([messageId])
  @@map("whatsapp_message_logs")
}

model ScheduledMessage {
  id           String   @id @default(cuid())
  userId       String
  instanceName String
  phoneNumber  String
  message      String   @db.Text
  scheduledFor DateTime
  
  status   String    @default("pending") // pending, sent, failed
  sentAt   DateTime?
  error    String?
  messageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@map("scheduled_messages")
}

model ScheduledTask {
  id           String   @id @default(cuid())
  userId       String
  actionType   String   // whatsapp_message, api_call, email, webhook, custom
  payload      Json     // dados específicos da ação
  scheduledFor DateTime
  
  status   String    @default("pending") // pending, processing, completed, failed
  result   Json?     // resultado da execução
  error    String?
  attempts Int       @default(0)
  maxRetries Int     @default(3)

  executedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@index([actionType])
  @@map("scheduled_tasks")
}
