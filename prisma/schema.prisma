generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model business_profiles {
  id           String                       @id
  userId       String
  personType   business_profiles_personType @default(PJ)
  status       business_profiles_status     @default(UNVERIFIED)
  cpf          String?                      @unique
  companyName  String?
  cnpj         String?                      @unique
  tradingName  String?
  description  String?                      @db.Text
  companyLogo  String?
  categories   String?
  cep          String?
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  latitude     Float?
  longitude    Float?
  instagram    String?
  facebook     String?
  whatsapp     String?
  website      String?
  createdAt    DateTime                     @default(now())
  updatedAt    DateTime
  users        users                        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model categories {
  id          String     @id
  userId      String
  name        String
  description String?    @db.Text
  icon        String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  users       users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  products    products[]

  @@unique([userId, name])
  @@index([userId])
}

enum ChannelType {
  whatsapp_evolution
  whatsapp_oficial
  sms
  email
  telegram
  facebook
}

model integration_credentials {
  id                  String                @id
  name                String                @unique
  type                ChannelType
  credentials         String                @db.LongText
  isActive            Boolean               @default(true)
  description         String?               @db.Text
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  messaging_instances messaging_instances[]

  @@index([isActive])
  @@index([type])
}

model messaging_instances {
  id                 String               @id
  userId             String
  name               String?              
  channel            ChannelType
  channelInstanceId  String
  channelPhoneOrId   String
  status             String               @default("pending")
  metadata           String?              @db.LongText
  credentialId       String?
  lastConnectedAt    DateTime?
  lastDisconnectedAt DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  users              users                @relation(fields: [userId], references: [id], onDelete: Cascade)
  messaging_messages messaging_messages[]
  credential         integration_credentials? @relation(fields: [credentialId], references: [id], onDelete: SetNull)

  @@unique([channel, channelInstanceId])
  @@index([channel])
  @@index([status])
  @@index([userId])
  @@index([credentialId])
}

model messaging_messages {
  id                  String              @id
  userId              String
  instanceId          String
  channel             String
  remoteJid           String
  message             String              @db.Text
  channelMessageId    String?             @unique
  direction           String              @default("sent")
  status              String              @default("pending")
  mediaUrl            String?
  mediaType           String?
  error               String?
  retries             Int                 @default(0)
  maxRetries          Int                 @default(3)
  sentAt              DateTime?
  deliveredAt         DateTime?
  readAt              DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  messaging_instances messaging_instances @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  users               users               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([channel])
  @@index([instanceId])
  @@index([status])
  @@index([userId])
}

model products {
  id            String          @id
  userId        String
  categoryId    String
  name          String
  description   String?         @db.Text
  sku           String
  price         Float
  quantity      Int
  image         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  categories    categories      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  users         users           @relation(fields: [userId], references: [id], onDelete: Cascade)
  quote_items   quote_items[]
  stock_entries stock_entries[]

  @@unique([userId, sku])
  @@index([categoryId])
  @@index([userId])
}

model quote_items {
  id        String   @id
  quoteId   String
  productId String
  quantity  Int
  unitPrice Float
  total     Float
  createdAt DateTime @default(now())
  updatedAt DateTime
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  quotes    quotes   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([quoteId])
}

model quotes {
  id          String        @id
  userId      String
  status      String        @default("pending")
  discount    Float         @default(0)
  tax         Float         @default(0)
  total       Float
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  quoteNumber String?
  quote_items quote_items[]
  users       users         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

model scheduled_messages {
  id           String    @id
  userId       String
  instanceName String
  phoneNumber  String
  message      String    @db.Text
  scheduledFor DateTime
  status       String    @default("pending")
  sentAt       DateTime?
  error        String?
  messageId    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  users        users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([scheduledFor])
  @@index([status])
  @@index([userId])
}

model scheduled_tasks {
  id           String    @id
  userId       String
  actionType   String
  payload      String    @db.LongText
  scheduledFor DateTime
  status       String    @default("pending")
  result       String?   @db.LongText
  error        String?
  attempts     Int       @default(0)
  maxRetries   Int       @default(3)
  executedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  users        users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([actionType])
  @@index([scheduledFor])
  @@index([status])
  @@index([userId])
}

model sessions {
  id           String   @id
  userId       String
  accessToken  String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_userId_fkey")
}

model stock_entries {
  id        String   @id
  userId    String
  productId String
  quantity  Int
  type      String   @default("in")
  reason    String?
  reference String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
}

model users {
  id                    String                  @id
  email                 String                  @unique
  name                  String
  password              String?
  avatar                String?
  phone                 String?
  cpf                   String?                 @unique
  birthDate             DateTime?
  whatsapp              String?
  instagram             String?
  facebook              String?
  role                  users_role              @default(USER)
  provider              users_provider?         @default(LOCAL)
  providerId            String?
  status                String                  @default("ACTIVE")
  isVerified            Boolean                 @default(false)
  isActive              Boolean                 @default(true)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  business_profiles     business_profiles[]
  categories            categories[]
  messaging_instances   messaging_instances[]
  messaging_messages    messaging_messages[]
  products              products[]
  quotes                quotes[]
  scheduled_messages    scheduled_messages[]
  scheduled_tasks       scheduled_tasks[]
  sessions              sessions[]
  stock_entries         stock_entries[]
  whatsapp_instances    whatsapp_instances[]
  whatsapp_message_logs whatsapp_message_logs[]
}

model whatsapp_instances {
  id                    String                  @id
  userId                String
  instanceName          String                  @unique
  phoneNumber           String?
  status                String                  @default("close")
  state                 String                  @default("DISCONNECTED")
  qrCode                String?                 @db.LongText
  webhookUrl            String?
  lastConnectedAt       DateTime?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  users                 users                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  whatsapp_message_logs whatsapp_message_logs[]

  @@index([instanceName])
  @@index([userId])
}

model whatsapp_message_logs {
  id                 String             @id
  userId             String
  instanceId         String
  remoteJid          String
  message            String             @db.Text
  messageId          String             @unique
  direction          String             @default("sent")
  status             String             @default("pending")
  mediaUrl           String?
  error              String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime
  whatsapp_instances whatsapp_instances @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  users              users              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([messageId])
  @@index([userId])
}

enum business_profiles_personType {
  PF
  PJ
}

enum business_profiles_status {
  UNVERIFIED
  VERIFIED
  CANCELLED
}

enum users_role {
  USER
  SELLER
  ADMIN
}

enum users_provider {
  LOCAL
  GOOGLE
  FACEBOOK
}
